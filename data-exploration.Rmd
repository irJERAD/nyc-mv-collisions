---
title: "NYC Open Data Exploration"
output: html_notebook
---

# About

This notebook explores the more recent data from NYC Open Data [Data Set](https://data.cityofnewyork.us/Public-Safety/NYPD-Motor-Vehicle-Collisions/h9gi-nx95).

This dataset can also be reached and interacted with through its [Google BigQuery location](https://bigquery.cloud.google.com/table/bigquery-public-data:new_york.nypd_mv_collisions?tab=schema)

## Exercise Overview

For this exercise, we'd like you to analyze data on New York motor vehicle collisions and answer the following question:    
**What are your ideas for reducing accidents in Brooklyn?**   
Imagine you are preparing this presentation for the city council who will use it to inform new legislation and/or projects.

### TODO

Briefly:  

1. Inspect dataset  
2. Identify dependent / outcome variables  
3. iterate over:  
    a. hypothesize predictor variables  
    b. test  
    c. document & consider results  
  
      
- Setup   
    + [ ] Libraries (_continual_)  
    + [x] data  
- Understand
    + [x] structure  
    + [x] summary  
    + [ ] identify dependent variables  

## Setup

### Load Libraries

Libraries that will be used during exploration
```{r libraries, warning=FALSE}
library(magrittr)
library(dplyr)
library(ggplot2)
library(plotly)
library(maps)
library(rgeos)
Sys.setenv('MAPBOX_TOKEN' =
             'pk.eyJ1IjoiaXJqZXJhZCIsImEiOiJjajA4cWNkajkwMjRrMnFvNnlwMGFhZmM5In0.5PGU5SV2qdyix9tSEkjMgg')
```

### Load Data

Load data from /data directory and into memory
```{r import-data, cache=TRUE}
dt <- read.csv(file = "data/NYPD_Motor_Vehicle_Collisions.csv")
```

## Undertand Dataset

### Dataset Structure

Inspect structure of dataset with the `str()` command:
```{r data-structure}
str(dt)
```

### Dataset Summary

Inspect summary of dataset with `summary()` command:
```{r data-summary}
summary(dt)
```


### Dataset Variables

Our Dataset structure revealed the variables and their classes `sapply(names(dt), function(x) paste0(x, ' is class: ', class(dt[[x]])))`= `r sapply(names(dt), function(x) paste0('<br>','<b>',x,'</b>','<em>',' is class: ','</em>','<u>',class(dt[[x]]),'</u>'))`

### Clean Data

Change Unmarked Boroughs from NA to "NONE GIVEN"
```{r}
levels(dt$BOROUGH)[levels(dt$BOROUGH) == ""] <- "BOROUGH NA"
```

### Map Variables  

With Latitude and Longitude present and appearing to be fairly well documented, let's take a quick look at how these accidents look over an interactive world map (incase of mistakes outlying somewhere aside from New York). We will use the `BOROUGH` variable as a factor. This gives the geographic association of each borough and allows us early forsight into anything specific about our point of interest `BOURGH == "BROOKLYN"`
```{r map-vars, warning=FALSE}
mp <- dt %>% plot_mapbox(lat = ~LATITUDE, lon = ~LONGITUDE, split = ~BOROUGH, mode = 'scattermapbox')
plotly_build(mp)
```
Here we can see at least one marked as `BOROUGH == "QUEENS"` sitting on the equator at lat, long (0,0). It is safe to assume that observation along with others in the Atlantic or Pacific Ocean and anywhere else outside of New York have mislabeled coordinates.  
These would be candidates for quick removal to save time, or cleaning if coordinate location was important enough on these observations to our intended results.  


### Understanding Conclusion  

With a goal of _reducing accidents in Brooklyn_ our main goal is to reduce observations of accidents where `BOROUGH == "BROOKLYN"`.  

#### Proposed Solutions:  

- Explore facets of variables  
    + Datetime  
        + Time of day  
        + Day of week
        + Day of month
        + Day or Month of year
- Explore trends `group_by`  
    + Across time  
    + Across space
        + Burrough
        + Zip
        + Street Name (On, Cross, Off)
    + Across Vehicle Type


**1. Subset:**
If we look at the subset of the dataset where BOROUGH is "BROOKLYN" `brooklyn <- filter(dt, BOROUGH == "BROOKLYN")` we want to find patterns in the existing observations and propose methods to eliminate these patterns.     

- There are `length(levels(dt$BOROUGH))`: `r length(levels(dt$BOROUGH))` levels in the factor variable `BOROUGH`  
- Including `levels(dt$BOROUGH)`: `r levels(dt$BOROUGH)`.  
- So we really have 5 defined Boroughs, Brooklyn being one of which, with the 6th being an `NA` or blank value.  
- Subsetting to Brooklyn gives us 223552 observations, reducing set of observations by over 75%  

- Explore facets of variables  
    + Datetime  
        + Time of day  
        + Day of week
        + Day of month
        + Day or Month of year
- Explore trends  
    + Across time

**2. Other Success (_over time_):**
Look for reductions in other burroughs over time and propose similar efforts.



## Exploration

### Subset to Brooklyn

Create subset of Brooklyn observations:
```{r filter-brooklyn}
brooklyn <- filter(dt, BOROUGH == "BROOKLYN")
```

### Look at CONTRIBUTING.FACTOR.*

```{r fact-1}
fact.1 <- brooklyn %>%
  group_by(CONTRIBUTING.FACTOR.VEHICLE.1) %>%
  tally(sort = TRUE)
fact.1
```

Only 3 factor levels appear over 10,000 times in the `brooklyn$CONTRIBUTING.FACTOR.VEHICLE.1` variable.  


#### Distribution of CONTRIBUTING.FACTOR.VEHICLE.1    

Explore quantile distribution of `brooklyn$CONTRIBUTING.FACTOR.VEHICLE.1` variable then use cumulative distribution to calculate the probability / percentage of factor levels below 10,000 and 5,000:  
```{r fact-dist}
quantile(fact.1$n)
ecdf(fact.1$n)(10000)
ecdf(fact.1$n)(5000)
```

An expected majority of `ecdf(fact.1$n)(10000)` = `r ecdf(fact.1$n)(10000) * 100`% are below 10,000 occurances.  
Of interest is still nearly 90% below 5,000 which also provides us double the defined contributing factors (since the largest observation is listed as "Unspecified")  

## Regression Analysis  

Searching for important variables.  
Mix multiple logical combinations of regressor variables against predictor variables of interest.  

### Predict BOROUGH  

Attemp to create a linear model trained to predict the BOROUGH location of an observation:  
```{r}
model1formula <- BOROUGH ~ DATE + TIME + CONTRIBUTING.FACTOR.VEHICLE.1
## Breaks R Session - dt is almost 1M observations Too Much
# mod1 <- lm(model1formula, data = dt)
```

naive bayes
```{r bayes12}
# create formula from vehicles 1 and 2 factors and code
formula1.2 = BOROUGH ~ CONTRIBUTING.FACTOR.VEHICLE.1 + 
  CONTRIBUTING.FACTOR.VEHICLE.2 + VEHICLE.TYPE.CODE.1 + VEHICLE.TYPE.CODE.2
b```

## Graphical Exploration

### Events per Borough

Start with a quick look at total events for each borough:
```{r hour-bar}
# create table with count of borough occurence
boroughCount <- dt %>% group_by(BOROUGH) %>% tally(sort = TRUE)

# plot bar chart of each Borough's event count
bCNT <- plot_ly(boroughCount, x = ~BOROUGH, y = ~n, type = 'bar')
# plot without None Given Borough
NObCNT <- plot_ly(boroughCount[2:6,], x = ~BOROUGH, y = ~n, type = 'bar')

# plot side-by-side
subplot(bCNT, NObCNT)
```
After removing the unmarked borough level "NONE GIVEN" we can see that Brooklyn has the greatest number of observed events in this dataset.  

Does that make Brooklyn the most dangerous place to drive? Most leathal?  
Things to consider:  
- Size of Brooklyn (area and total length of roads)  
- Number of drivers in Brooklyn (perhaps driving is more popular there than Manhattan)  
- Average driver profile (professional Cab drivers in the city have different accident distributions than family drivers in Brooklyn)  
c
### Time of Day  

Create a Bar chart for Accidents across hours of the day.  
Modification to consider:  
group by:  
- Borough  
- Contributing Factor  
Scale by:  
- Number of fatalities  
- Number of injuries  

### Chotorpeth

```{r}
# map pojection / options
g <- list(
  scope = 'New York NY',
  projection = list(type = 'albers usa'),
  showland = TRUE,
  landcolor = toRGB('gray85')
  # ,
  # subunitwidth = 1,
  # countrywidth = 1,
  # subunitcolor = toRGB("white"),
  # countrycolor = toRGB("white")
)

pMap <- plot_geo(dt)
```
map_data("world", "canada") %>%   
..group_by(group) %>%   
..plot_geo(x = ~long, y = ~lat) %>%   
..add_markers(size = I(1))    

### 

Variable assets:    
-< Location = On Street + Cross Street    
-< Size = Number of accidents   
-< Color grade = Damage of Accidents    

### Map of Buroughs with ggplot PLotly

TODO: Show method that downloads map data from NY Open Data [Here](http://stackoverflow.com/questions/32252505/how-to-map-new-york-city-using-map-function-in-r)
```{r}
## TODO: change to hidden path
# solution: use API for zip file
# nyc <- readOGR("/Users/irJERAD/Documents/Data-Apps/Interview-exercise/nyc-mv-collisions/data/nybbwi_17a", stringsAsFactors = FALSE)

# change to data directory
work <- getwd()
setwd("data")

# download and unzip shapefiles tp data frame
url <- "http://www1.nyc.gov/assets/planning/download/zip/data-maps/open-data/nybb_17a.zip"
zip_sdf <- basename(url)
if (!file.exists(zip_sdf)) download.file(url, zip_sdf)
# unzip into spacial data frame
map_sdf <- unzip(zip_sdf)

nyc_sdf <- readOGR(map_sdf[1], ogrListLayers(map_sdf[1])[1],
                  stringsAsFactors = FALSE)
# return to project's working directory
setwd(work)

nyc_map <- fortify(gSimplify(nyc_sdf, 0.05))

gg <- ggplot()
gg <- gg + geom_map(data = nyc_map, map = nyc_map,
                    aes(x = long, y = lat, map_id = id),
                    color = "black", fill = "white", size = 0.25)
gg <- gg + coord_equal() 
#gg <- gg + theme_map()
gg
```

